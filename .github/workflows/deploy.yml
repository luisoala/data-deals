name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for pushing commits back to repo
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint || true
        continue-on-error: true

      - name: Upload files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          source: "."
          target: "/tmp/data-deals-deploy"
          strip_components: 0
          exclude: |
            node_modules
            .git
            .next
            prisma/dev.db
            dev.db
            venv
            __pycache__
            *.log

      - name: Bootstrap and Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          OAUTH_CLIENT_ID: ${{ secrets.OAUTH_CLIENT_ID }}
          OAUTH_CLIENT_SECRET: ${{ secrets.OAUTH_CLIENT_SECRET }}
          ADMIN_GITHUB_USERNAMES: ${{ secrets.ADMIN_GITHUB_USERNAMES }}
          NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          CERTBOT_EMAIL: ${{ secrets.CERTBOT_EMAIL }}
          GITHUB_TOKEN: ${{ github.token }}  # Built-in token with repo write access
          GITHUB_REPOSITORY: ${{ github.repository }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            set -e
            echo "Starting deployment..."
            
            APP_DIR="/home/ubuntu/data-deals"
            DEPLOY_DIR="/tmp/data-deals-deploy"
            
            # Check if this is first-time setup
            if [ ! -d "$APP_DIR" ] || [ ! -f "$APP_DIR/package.json" ]; then
              echo "First-time setup detected. Running bootstrap..."
              
              # Install basic dependencies if needed
              if ! command -v node &> /dev/null; then
                echo "Installing Node.js 20..."
                curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
                sudo apt-get install -y nodejs
              fi
              
              if ! command -v pm2 &> /dev/null; then
                echo "Installing PM2..."
                sudo npm install -g pm2
              fi
              
              if ! command -v nginx &> /dev/null; then
                echo "Installing Nginx..."
                sudo apt-get update -qq
                sudo apt-get install -y nginx
              fi
              
              # Install certbot for Let's Encrypt SSL if domain is provided
              if [ -n "${DOMAIN_NAME:-}" ] && ! command -v certbot &> /dev/null; then
                echo "Installing certbot for SSL..."
                sudo apt-get update -qq
                sudo apt-get install -y certbot python3-certbot-nginx
              fi
              
              # Create application directory
              echo "Creating application directory..."
              mkdir -p "$APP_DIR"
              
              # Determine server name
              SERVER_NAME="${DOMAIN_NAME:-_}"
              
              # Set up Nginx - HTTP server (for Let's Encrypt challenge or fallback)
              echo "Configuring Nginx..."
              if [ -n "${DOMAIN_NAME:-}" ]; then
                # HTTPS configuration with SSL
                sudo tee /etc/nginx/sites-available/data-deals > /dev/null <<EOF
            server {
                listen 80;
                server_name $SERVER_NAME;
                
                # Let's Encrypt challenge
                location /.well-known/acme-challenge/ {
                    root /var/www/html;
                }
                
                # Redirect HTTP to HTTPS
                location / {
                    return 301 https://\$host\$request_uri;
                }
            }
            
            server {
                listen 443 ssl http2;
                server_name $SERVER_NAME;
            
                ssl_certificate /etc/letsencrypt/live/$SERVER_NAME/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/$SERVER_NAME/privkey.pem;
                ssl_protocols TLSv1.2 TLSv1.3;
                ssl_ciphers HIGH:!aNULL:!MD5;
                ssl_prefer_server_ciphers on;
            
                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto \$scheme;
                    proxy_cache_bypass \$http_upgrade;
                }
            }
            EOF
              else
                # HTTP only configuration (no domain)
                sudo tee /etc/nginx/sites-available/data-deals > /dev/null <<EOF
            server {
                listen 80;
                server_name _;
            
                location / {
                    proxy_pass http://localhost:3000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade \$http_upgrade;
                    proxy_set_header Connection 'upgrade';
                    proxy_set_header Host \$host;
                    proxy_cache_bypass \$http_upgrade;
                }
            }
            EOF
              fi
              
              sudo ln -sf /etc/nginx/sites-available/data-deals /etc/nginx/sites-enabled/
              sudo rm -f /etc/nginx/sites-enabled/default
              sudo nginx -t
              sudo systemctl restart nginx
              sudo systemctl enable nginx
              
              # Set up SSL certificate if domain is provided
              if [ -n "${DOMAIN_NAME:-}" ]; then
                echo "Setting up SSL certificate for $DOMAIN_NAME..."
                # Check if certificate already exists
                if [ ! -f "/etc/letsencrypt/live/$DOMAIN_NAME/fullchain.pem" ]; then
                  echo "Obtaining SSL certificate from Let's Encrypt..."
                  # Ensure Nginx is running for verification
                  sudo systemctl restart nginx || true
                  # Run certbot in non-interactive mode
                  CERTBOT_EMAIL_VAL="${CERTBOT_EMAIL:-admin@$DOMAIN_NAME}"
                  sudo certbot --nginx -d "$DOMAIN_NAME" --non-interactive --agree-tos --email "$CERTBOT_EMAIL_VAL" --redirect || {
                    echo "WARNING: SSL certificate setup failed. Continuing without SSL."
                    echo "You can manually run: sudo certbot --nginx -d $DOMAIN_NAME"
                    echo "Make sure DNS is pointing to this server and ports 80/443 are open."
                  }
                else
                  echo "SSL certificate already exists, renewing if needed..."
                  sudo certbot renew --quiet || true
                fi
                
                # Set up auto-renewal
                if ! grep -q "certbot renew" /etc/crontab 2>/dev/null; then
                  echo "Setting up SSL certificate auto-renewal..."
                  (crontab -l 2>/dev/null; echo "0 3 * * * certbot renew --quiet --post-hook 'systemctl reload nginx'") | crontab -
                fi
              fi
              
              # Set up PM2
              pm2 startup systemd -u ubuntu --hp /home/ubuntu | grep -v "PM2" | sudo bash || true
              
              # Create .env file if it doesn't exist
              if [ ! -f "$APP_DIR/.env" ]; then
                echo "Creating .env file..."
                
                # Determine NEXTAUTH_URL based on domain or EC2_HOST
                # Use domain with HTTPS if available, otherwise use EC2_HOST with HTTP
                if [ -n "${DOMAIN_NAME:-}" ]; then
                  NEXTAUTH_URL="https://$DOMAIN_NAME"
                elif [ -n "${EC2_HOST:-}" ]; then
                  NEXTAUTH_URL="http://$EC2_HOST"
                else
                  # Fallback to metadata service or localhost
                  EC2_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "")
                  if [ -z "$EC2_IP" ]; then
                    EC2_IP="localhost:3000"
                  fi
                  NEXTAUTH_URL="http://$EC2_IP"
                fi
                
                # Use GitHub secrets if available, otherwise use template
                OAUTH_CLIENT_ID="${OAUTH_CLIENT_ID:-}"
                OAUTH_CLIENT_SECRET="${OAUTH_CLIENT_SECRET:-}"
                ADMIN_USERNAMES="${ADMIN_GITHUB_USERNAMES:-}"
                NEXTAUTH_SECRET="${NEXTAUTH_SECRET:-$(openssl rand -base64 32)}"
                
                cat > "$APP_DIR/.env" <<ENVEOF
            # Database
            DATABASE_URL="file:./prisma/prod.db"
            
            # NextAuth
            NEXTAUTH_URL="$NEXTAUTH_URL"
            NEXTAUTH_SECRET="$NEXTAUTH_SECRET"
            
            # GitHub OAuth
            GITHUB_CLIENT_ID="$OAUTH_CLIENT_ID"
            GITHUB_CLIENT_SECRET="$OAUTH_CLIENT_SECRET"
            
            # Admin Access
            ADMIN_GITHUB_USERNAMES="$ADMIN_USERNAMES"
            ENVEOF
                
                if [ -z "$OAUTH_CLIENT_ID" ] || [ -z "$OAUTH_CLIENT_SECRET" ]; then
                  echo "WARNING: .env file created with template. Please update GitHub OAuth values!"
                  echo "Option 1: SSH in and edit: nano $APP_DIR/.env"
                  echo "Option 2: Add as GitHub Secrets and redeploy"
                else
                  echo ".env file created with values from GitHub Secrets"
                fi
                echo "NEXTAUTH_URL set to: $NEXTAUTH_URL"
              fi
              
              echo "Bootstrap complete!"
            fi
            
            # Copy uploaded files to app directory (preserving .env if it exists)
            echo "Copying files to application directory..."
            if [ -f "$APP_DIR/.env" ]; then
              cp "$APP_DIR/.env" "$DEPLOY_DIR/.env"
            fi
            rsync -av --delete --exclude='node_modules' --exclude='.next' --exclude='.env' "$DEPLOY_DIR/" "$APP_DIR/"
            if [ -f "$DEPLOY_DIR/.env" ]; then
              mv "$DEPLOY_DIR/.env" "$APP_DIR/.env"
            fi
            
            # Validate and fix NEXTAUTH_URL if invalid
            if [ -f "$APP_DIR/.env" ]; then
              echo "Validating .env file..."
              
              # Determine correct NEXTAUTH_URL
              if [ -n "${DOMAIN_NAME:-}" ]; then
                EXPECTED_URL="https://$DOMAIN_NAME"
              elif [ -n "${EC2_HOST:-}" ]; then
                EXPECTED_URL="http://$EC2_HOST"
              else
                # Fallback to metadata service
                EC2_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo "")
                if [ -z "$EC2_IP" ]; then
                  EC2_IP="localhost:3000"
                fi
                EXPECTED_URL="http://$EC2_IP"
              fi
              
              # Check if NEXTAUTH_URL is invalid or doesn't match expected
              CURRENT_URL=$(grep '^NEXTAUTH_URL=' "$APP_DIR/.env" | cut -d'"' -f2 || echo "")
              
              if grep -q '^NEXTAUTH_URL="http://"$' "$APP_DIR/.env" || \
                 grep -q '^NEXTAUTH_URL="https://"$' "$APP_DIR/.env" || \
                 grep -q '^NEXTAUTH_URL=$' "$APP_DIR/.env" || \
                 [ "$CURRENT_URL" != "$EXPECTED_URL" ]; then
                echo "Updating NEXTAUTH_URL to: $EXPECTED_URL"
                sed -i "s|^NEXTAUTH_URL=.*|NEXTAUTH_URL=\"$EXPECTED_URL\"|" "$APP_DIR/.env"
              else
                echo "NEXTAUTH_URL is valid: $CURRENT_URL"
              fi
            fi
            
            cd "$APP_DIR" || exit 1
            
            # Run deployment script
            echo "Running deployment script..."
            bash scripts/deploy.sh || exit 1
            
            # Verify deployment
            echo "Verifying deployment..."
            sleep 5
            if pm2 list | grep -q "data-deals.*online"; then
              echo "Deployment successful!"
            else
              echo "ERROR: Deployment failed - PM2 process not running"
              pm2 logs data-deals --lines 50
              exit 1
            fi
            
            # Clean up deploy directory
            rm -rf "$DEPLOY_DIR"

